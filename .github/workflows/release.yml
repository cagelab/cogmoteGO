name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    strategy:
      matrix:
        include:
          - target: linux-amd64
            os: ubuntu-latest
          - target: linux-arm64
            os: ubuntu-24.04-arm
          - target: darwin-arm64
            os: macos-latest
          - target: darwin-amd64
            os: macos-15-intel
          - target: windows-amd64
            os: windows-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"

      - name: Install Dependencies on Linux
        if: startsWith(matrix.target, 'linux-')
        run: |
          sudo apt-get update
          sudo apt-get install -y libzmq3-dev pkg-config

      - name: Install Dependencies on macOS
        if: startsWith(matrix.target, 'darwin-')
        run: |
          brew install zeromq

      - name: Export GitHub Actions cache environment variables for vcpkg
        if: startsWith(matrix.target, 'windows-')
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install Dependencies on Windows
        if: startsWith(matrix.target, 'windows-')
        shell: pwsh
        run: vcpkg install
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

      - name: Build and Package on Linux and macOS
        if: startsWith(matrix.target, 'linux-') || startsWith(matrix.target, 'darwin-')
        run: |
          chmod +x ${{ github.workspace }}/scripts/build.sh
          SHORT_SHA=$(git rev-parse --short "${{ github.sha }}")
          ${{ github.workspace }}/scripts/build.sh --ci \
            --version "${{ needs.release-please.outputs.tag_name }}" \
            --commit "$SHORT_SHA"

      - name: Build and Package on Windows
        if: startsWith(matrix.target, 'windows-')
        shell: pwsh
        run: |
          $shortSha = git rev-parse --short "${{ github.sha }}"
          ${{ github.workspace }}\scripts\build.ps1 -CI -Version "${{ needs.release-please.outputs.tag_name }}" -Commit $shortSha

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-${{ matrix.target }}
          path: dist/
          retention-days: 1

  upload-release:
    needs: [release-please, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: dist/*
